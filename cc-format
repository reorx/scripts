#!/bin/bash
# Made for Claude Code hooks

CONFIG_DIR="$HOME/.config/cc-format"
IS_OFF_FILE="$CONFIG_DIR/is_off"

usage() {
    if [ -n "$CONTROL_MODE" ]; then
        echo "Usage: $0 <action>"
        echo "Control actions:"
        echo "  toggle    - turn on or off cc-format"
        echo "  status    - show status of cc-format"
    else
        echo "Usage: $0 <filename>"
        echo "Formats files based on their extension:"
        echo "  .py       - formatted with ruff"
        echo "  .ts/.tsx/.js - formatted with biome"
    fi
    exit 1
}

control_mode() {
    local action="$1"
    
    # Ensure config directory exists
    mkdir -p "$CONFIG_DIR"
    
    case "$action" in
        toggle)
            if [ -f "$IS_OFF_FILE" ]; then
                # Turn on
                rm "$IS_OFF_FILE"
                echo "cc-format is now ON"
            else
                # Turn off
                touch "$IS_OFF_FILE"
                echo "cc-format is now OFF"
            fi
            ;;
        status)
            if [ -f "$IS_OFF_FILE" ]; then
                echo "cc-format is OFF"
            else
                echo "cc-format is ON"
            fi
            ;;
        *)
            echo "Error: Unknown action '$action'"
            usage
            ;;
    esac
}

# Check arguments
[ $# -eq 0 ] && usage

# Check if CONTROL_MODE is set
if [ -n "$CONTROL_MODE" ]; then
    control_mode "$1"
    exit 0
fi

# Check if cc-format is disabled
if [ -f "$IS_OFF_FILE" ]; then
    if [ -n "$DEBUG" ]; then
        echo "cc-format is disabled, skipping formatting" >&2
    fi
    exit 0
fi

# Get the file path from the first argument
FILE="$1"

# Check if the file exists
if [ ! -f "$FILE" ]; then
    echo "Error: File '$FILE' does not exist"
    exit 1
fi

# Extract the file extension
EXTENSION="${FILE##*.}"

# Set extra args based on NO_WRITE
if [ -n "$NO_WRITE" ]; then
    RUFF_EXTRA="--diff"
    BIOME_EXTRA=""
else
    RUFF_EXTRA=""
    BIOME_EXTRA="--write"
fi

# Format based on extension
case "$EXTENSION" in
    py)
        #echo "Formatting Python file with ruff..."
        ruff format $RUFF_EXTRA \
            --line-length 120 \
            --config "format.quote-style = 'single'" \
            "$FILE"
        ;;
    ts|tsx|js)
        #echo "Formatting $EXTENSION file with biome..."
        biome format $BIOME_EXTRA \
            --indent-style=space --line-width=120 \
            --javascript-formatter-quote-style=single \
            "$FILE"
        ;;
    *)
        echo "Error: Unsupported file type '.$EXTENSION'"
        exit 1
        ;;
esac
